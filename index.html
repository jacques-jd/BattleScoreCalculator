<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>Piggy Battle Simulator</title>
    <style>
        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 1rem;
        }
    </style>
    <script>
        window.addEventListener("load", () => {
            let results = document.querySelector("#results");

            let piggy = {
                ap: 0,
                as: 0,
                def: 0,
                reg: 0,
                hp: 0,
                crit: 0
            };

            let form = {
                ap: document.querySelector("#ap"),
                as: document.querySelector("#as"),
                def: document.querySelector("#def"),
                reg: document.querySelector("#reg"),
                hp: document.querySelector("#hp"),
                crit: document.querySelector("#crit")
            };

            document.querySelector("#fillOut").addEventListener("click", e => {
                form.ap.value = 138.1681;
                form.as.value = 1.6561;
                form.def.value = 160.2064;
                form.reg.value = 32.55;
                form.hp.value = 2140.3867;
                form.crit.value = 31.5136;
            });

            document.querySelector("#submit").addEventListener("click", e => {
                if(!validateFormValues(form)) {
                    results.innerText = "Form is not filled out completely with positive numerical values.";
                    return;
                }

                savePiggyStats(piggy, form);

                let scores = calculatePiggyBattle(piggy);

                displayResults(scores);
            });
        });

        let validateFormValues = form => {
            for (let key in form) {
                if (form[key].value === "") {
                    return false;
                }

                if (form[key].value < 0) {
                    return false;
                }

                if (!isNaN(form[key])) {
                    return false;
                }
            }

            return true;
        }

        let savePiggyStats = (piggy, form) => {
            let piggyStats = document.querySelector("#piggy")

            piggy.ap = parseFloat(form.ap.value);
            piggy.as = parseFloat(form.as.value);
            piggy.def = parseFloat(form.def.value);
            piggy.reg = parseFloat(form.reg.value);
            piggy.hp = parseFloat(form.hp.value);
            piggy.crit = parseFloat(form.crit.value);

            let statValues = [];
            let ul = document.createElement("ul");

            //dynamically creating a string while fetching the stats 
            for (let key in piggy) {
                let li = document.createElement("li");
                li.textContent = `${key.toUpperCase()}: ${piggy[key]}`;

                ul.appendChild(li);
            }
            
            //gonna clear out piggyStats first
            while(piggyStats.firstChild) {
                piggyStats.removeChild(piggyStats.firstChild);
            }

            //adding the stats
            piggyStats.appendChild(ul);
        }

        let calculatePiggyBattle = piggy => {
            let defScore = piggy.hp + (piggy.def * 3) + (piggy.reg * 10);
            let atkScore = 0;

            for (let i = 0; i < 10; i++) {
                let critMultiplier = 0.5 * Math.floor(piggy.crit / 100);
                let bonusCrit = 0.5 + 0.5 * Math.floor(piggy.crit / 100);
                let finalCritMultiplier = 1 + critMultiplier;

                // gets the last 2 digits of the crit
                let critChance = piggy.crit % 100;

                // if the random number is less than or equal to the crit chance, then add bonus crit to final crit multiplier
                if (Math.random() * 100 <= critChance) {
                    finalCritMultiplier += bonusCrit;
                }

                atkScore += ((piggy.ap * piggy.as) * finalCritMultiplier);
            }

            return {atkScore: atkScore.toFixed(4), defScore: defScore.toFixed(4)};
        }

        let displayResults = scores => { 
            let results = document.querySelector("#results");
            let totalScore = parseFloat(scores.atkScore) + parseFloat(scores.defScore);
            results.textContent = `Attack Score: ${scores.atkScore}
            Defense Score: ${scores.defScore}
            Total Score: ${totalScore}`;
        }

    </script>
</head>
<body>
    <div class="container">
        <h1>Piggy Battle Simulator</h1>
        <!-- Piggy Battle Simulator. Form inputs:
        AP, AS, DEF, REG, HP, CRIT -->
        <div class="form-item mb-3">
            <button type="submit" class="btn btn-primary" id="fillOut">Fill out w/ Joe</button>
        </div>
        <div class="grid">
            <div class="form-item mb-3 ">
                <label for="ap" class="form-label">AP</label>
                <input type="number" name="ap" id="ap" class="form-control">
            </div>
            <div class="form-item mb-3">
                <label for="as" class="form-label">AS</label>
                <input type="number" name="as" id="as" class="form-control">
            </div>
            <div class="form-item mb-3">
                <label for="def" class="form-label">DEF</label>
                <input type="number" name="def" id="def" class="form-control">
            </div>
            <div class="form-item mb-3">
                <label for="reg" class="form-label">REG</label>
                <input type="number" name="reg" id="reg" class="form-control">
            </div>
            <div class="form-item mb-3">
                <label for="hp" class="form-label">HP</label>
                <input type="number" name="hp" id="hp" class="form-control">
            </div>
            <div class="form-item mb-3">
                <label for="crit" class="form-label">CRIT</label>
                <input type="number" name="crit" id="crit" class="form-control">
            </div>
        </div>
        <div class="form-item mb-3">
            <button type="submit" class="btn btn-primary" id="submit">Simulate</button>
        </div>
        <div class="inline card" id="piggy">
        </div>
        <h2>Results</h2>
        <div class="m-3" id="results">

        </div>
    </div>
</body>
</html>